<view class="page">
  <!-- èƒŒæ™¯å›¾å±‚ï¼ˆå……æ»¡æ•´ä¸ª .pageï¼Œé«˜åº¦éšå†…å®¹å¢é•¿ï¼‰ -->
  <view class="bg-image"></view>
  
  <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
  <view class="step-indicator">
    <view class="step-dots">
      <view class="dot {{currentStep === index ? 'active' : ''}}" 
            tt:for="{{stepTitles}}" tt:key="index" tt:for-index="index">
      </view>
    </view>
    <text class="step-title">{{stepTitles[currentStep]}}</text>
    
    <!-- è¿›åº¦æ¡ -->
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progressPercentage}}%"></view>
      </view>
      <text class="progress-text">{{progressPercentage}}%</text>
    </view>
  </view>

  <!-- æ»‘åŠ¨å®¹å™¨ -->
  <view class="swipe-container">
    <swiper class="swiper" 
            current="{{currentStep}}" 
            bindchange="onSwiperChange"
            disable-touch="{{false}}">
      
      <!-- ======================================================= -->
      <!-- ===================== ç¬¬ä¸€ä¸ªæ»‘å— ======================= -->
      <!--   åŒ…å«ï¼šè®¡åˆ’åç§°ã€é¢„ç®—åŒºé—´ã€æ¸¸ç©æ—¶é—´                     -->
      <!-- ======================================================= -->
      <swiper-item>
        <scroll-view scroll-y="true" class="step-content-scrollable">
          <!-- æ¨¡å—1: è®¡åˆ’åç§° -->
          <view class="step-content">
            <view class="step-header">
              <text class="step-number">1</text>
              <text class="step-label">åŸºæœ¬ä¿¡æ¯</text>
            </view>
            <view class="input-section">
              <text class="section-title">è®¡åˆ’åç§°</text>
              <view class="card-input">
                <input class="ipt" 
                       placeholder="è¯·è¾“å…¥è®¡åˆ’åç§°" 
                       value="{{form.planName}}" 
                       bindinput="onPlanNameInput" />
              </view>
            </view>
            

          <!-- åˆ†å‰²çº¿ -->
          <view class="divider"></view>

        
            <view class="budget-section">
              <text class="section-title">é¢„ç®—åŒºé—´</text>
              <view class="budget-range">
                <view class="budget-input">
                  <text class="budget-label">æœ€ä½</text>
                  <input class="budget-ipt" 
                         type="number" 
                         placeholder="æœ€ä½é¢„ç®—ï¼ˆï¿¥ï¼‰" 
                         value="{{form.budgetMin}}" 
                         bindinput="onBudgetMin" />
                  <text class="budget-unit">å…ƒ</text>
                </view>
                <view class="budget-input">
                  <text class="budget-label">æœ€é«˜</text>
                  <input class="budget-ipt" 
                         type="number" 
                         placeholder="æœ€é«˜é¢„ç®—ï¼ˆï¿¥ï¼‰" 
                         value="{{form.budgetMax}}" 
                         bindinput="onBudgetMax" />
                  <text class="budget-unit">å…ƒ</text>
                </view>
              </view>
          </view>

          <!-- åˆ†å‰²çº¿ -->
          <view class="divider"></view>

          <!-- æ¨¡å—3: æ¸¸ç©æ—¶é—´ -->


            

            <view class="time-section">
              <text class="step-label">æ¸¸ç©æ—¶é—´</text>
              <view class="time-row">
                <text class="time-label">æ¸¸ç©æ—¥æœŸ</text>
                <picker mode="date" value="{{form.playDate}}"
                        start="{{dateBounds.start}}" end="{{dateBounds.end}}"
                        bindchange="onDateChange">
                  <view class="picker-input">
                    <text class="picker-text">{{form.playDate || 'é€‰æ‹©æ—¥æœŸ'}}</text>
                    <text class="picker-arrow">></text>
                  </view>
                </picker>
              </view>
              <view class="time-row">
                <text class="time-label">å¼€å§‹æ—¶é—´</text>
                <picker mode="time" value="{{form.startTime}}" bindchange="onStartTimeChange">
                  <view class="picker-input">
                    <text class="picker-text">{{form.startTime || 'é€‰æ‹©æ—¶é—´'}}</text>
                    <text class="picker-arrow">></text>
                  </view>
                </picker>
              </view>
              <view class="time-row">
                <text class="time-label">ç»“æŸæ—¶é—´</text>
                <picker mode="time" value="{{form.endTime}}" bindchange="onEndTimeChange">
                  <view class="picker-input">
                    <text class="picker-text">{{form.endTime || 'é€‰æ‹©æ—¶é—´'}}</text>
                    <text class="picker-arrow">></text>
                  </view>
                </picker>
              </view>
              <view class="time-hint">
                <text class="hint-text">ğŸ’¡ é€‰æ‹©æ‚¨çš„æ¸¸ç©æ—¶é—´æ®µ</text>
              </view>
            </view>
    
        </scroll-view>
      </swiper-item>

      <!-- ======================================================= -->
      <!-- ===================== ç¬¬äºŒä¸ªæ»‘å— ======================= -->
      <!--   åŒ…å«ï¼šé€‰æ‹©å‡ºå‘ç‚¹ã€é‚€è¯·åŒè¡Œè€…                          -->
      <!-- ======================================================= -->
      <swiper-item>
        <scroll-view scroll-y="true" class="step-content-scrollable">
          <!-- æ¨¡å—1: é€‰æ‹©å‡ºå‘ç‚¹ -->
          <view class="step-content">
            <view class="step-header">
              <text class="step-number">2</text>
              <text class="step-label">é€‰æ‹©å‡ºå‘ç‚¹</text>
            </view>
            <!-- æœç´¢æ¡† -->
            <view class="search-section">

              <view class="search-input-container">
                
                <input class="search-input" 
                       placeholder="æœç´¢åœ°ç‚¹ä½œä¸ºå‡ºå‘ç‚¹" 
                       value="{{searchKeyword}}" 
                       bindinput="onSearchInput"
                       bindconfirm="onSearchConfirm" />
                <view class="search-btn" bindtap="onSearchConfirm">
                  <text class="search-icon">ğŸ”</text>
                </view>
              </view>
              
              <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
              <view class="search-results" tt:if="{{searchResults.length > 0}}">
                <view class="search-result-item" 
                      tt:for="{{searchResults}}" 
                      tt:key="index" 
                      tt:for-item="item" 
                      tt:for-index="index"
                      bindtap="onSelectSearchResult" 
                      data-item="{{item}}">
                  <text class="result-name">{{item.name}}</text>
                  <text class="result-address">{{item.address}}</text>
                </view>
              </view>
            </view>
            <!-- åœ°å›¾åŒºåŸŸ -->
            <view class="mapbox">
              <map
                class="map"
                id="map"
                longitude="{{mapState.longitude}}"
                latitude="{{mapState.latitude}}"
                scale="{{mapState.scale}}"
                markers="{{mapState.markers}}"
                circles="{{mapState.circles}}"
                show-location="true"
                enable-zoom="true"
                enable-scroll="true"
                enable-rotate="false"
                enable-overlooking="false"
                bindregionchange="onRegionChange"
              ></map>

              <view class="map-controls">
                <button class="map-btn" size="mini" bindtap="locateMe">æˆ‘çš„ä½ç½®</button>
                <button class="map-btn" size="mini" bindtap="onPickLocation">é€‰æ‹©åœ°å›¾ä½ç½®</button>
                <view class="zoom">
                  <button class="map-btn" size="mini" bindtap="zoomIn">+</button>
                  <button class="map-btn" size="mini" bindtap="zoomOut">-</button>
                </view>
              </view>

              <view class="map-center-pin"></view>
              <button class="map-center-cta" size="mini" bindtap="useCenterAsOrigin">ä»¥å½“å‰ä¸­å¿ƒä¸ºå‡ºå‘ç‚¹</button>
            </view>
            
            <!-- å‡ºå‘ç‚¹ä¿¡æ¯æ˜¾ç¤º -->
            <view class="location-section">
              <view class="location-display">
                <text class="location-name">{{form.origin.name || 'è¯·é€‰æ‹©å‡ºå‘ç‚¹'}}</text>
                <text class="location-address">{{form.origin.address || 'ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®'}}</text>
              </view>
              <view class="map-hint">
                <text class="hint-text">ğŸ’¡ ç‚¹å‡»åœ°å›¾é€‰æ‹©å‡ºå‘ç‚¹ï¼Œæˆ–ä½¿ç”¨å®šä½æŒ‰é’®</text>
              </view>
            </view>

          
          <!-- åˆ†å‰²çº¿ -->
          <view class="divider"></view>

          <!-- æ¨¡å—2: é‚€è¯·åŒè¡Œè€… -->

           
          

            <view class="partner-search-container">
              <text class="section-title">é‚€è¯·åŒè¡Œè€…</text>

              <view class="instr-title">é€šè¿‡æœç´¢æ·»åŠ </view>
              <view class="search-input-wrapper">
                <input 
                  class="search-input"
                  placeholder="è¾“å…¥åŒè¡Œè€…çš„å¤§è‡´ä½ç½®"
                  value="{{partnerSearchKeyword}}"
                  confirm-type="search"
                  bindinput="onPartnerSearchInput"
                  bindconfirm="onPartnerSearchConfirm"
                />
                <button class="search-btn" size="mini" type="primary" bindtap="onPartnerSearchConfirm">æœç´¢</button>
              </view>
        
              <view class="search-results-list" tt:if="{{partnerSearchResults.length > 0}}">
                <view 
                  class="result-item" 
                  tt:for="{{partnerSearchResults}}" 
                  tt:key="id"
                  data-item="{{item}}"
                  bindtap="onSelectPartnerSearchResult"
                >
                  <view class="result-name">{{item.name}}</view>
                  <view class="result-address">{{item.address}}</view>
                </view>
              </view>
            </view>
            
            <view class="divider"></view>
        
            <view class="partner-list-title">å·²æ·»åŠ  ({{partners.length}}äºº)</view>
            <view class="partner-list">
              <block tt:if="{{partners.length > 0}}">
                <view class="partner-item" tt:for="{{partners}}" tt:key="id">
                  <input 
                    class="partner-name-input"
                    value="{{item.name}}"
                    placeholder="è¾“å…¥æ˜µç§°"
                    data-id="{{item.id}}"
                    bindinput="onPartnerNameInput"
                  />
                  <view class="partner-address">{{item.address}}</view>
                  <button class="delete-btn" size="mini" type="warn" bindtap="onDeletePartner" data-id="{{item.id}}">åˆ é™¤</button>
                </view>
              </block>
              <block tt:else>
                <view class="empty-partners">
                  <text>æš‚æœªæ·»åŠ ä»»ä½•åŒè¡Œè€…</text>
                </view>
              </block>
            </view>
            <view class="range-section">
              <view class="section-title">åœ°ç‚¹è·ç¦»èŒƒå›´</view>
              <view class="range-item">
                <text class="range-label">è·ç¦»èŒƒå›´ï¼š{{form.distance}} km</text>
                <slider class="slider" 
                        min="0" max="30" step="1" value="{{form.distance}}"
                        bindchanging="onDistanceChanging" bindchange="onDistanceChange" />
              </view>
              <view class="range-item">
                <text class="range-label">å…¬å…±äº¤é€šï¼š{{form.maxTransitTime}} åˆ†é’Ÿ</text>
                <slider class="slider" 
                        min="0" max="75" step="5" value="{{form.maxTransitTime}}"
                        bindchange="onTransitChange" />
              </view>
              <view class="range-item">
                <text class="range-label">æ‰“è½¦æ—¶é—´ï¼š{{form.taxiTime}} åˆ†é’Ÿ</text>
                <slider class="slider" 
                        min="0" max="90" step="5" value="{{form.taxiTime}}"
                        bindchange="onTaxiChange" />
              </view>
            </view>
          </view>
        </scroll-view>
      </swiper-item>

      <!-- ======================================================= -->
      <!-- ===================== ç¬¬ä¸‰ä¸ªæ»‘å— ======================= -->
      <!--   åŒ…å«ï¼šé€‰æ‹©åœ°ç‚¹ç±»å‹ã€æè¿°åå¥½                          -->
      <!-- ======================================================= -->
      <swiper-item>
        <scroll-view scroll-y="true" class="step-content-scrollable">
          <!-- æ¨¡å—1: ç›®çš„åœ°ç±»å‹ -->
          <view class="step-content">
            <view class="step-header">
              <text class="step-number">3</text>
              <text class="step-label">ç›®çš„åœ°ç±»å‹</text>
            </view>
            <view class="type-section">
              <view class="chip-row">
                <view class="chip {{ selectedMap['é¤é¥®'] ? 'chip-active' : '' }}" data-name="é¤é¥®" bindtap="toggleType">é¤é¥®</view>
                <view class="chip {{ selectedMap['è´­ç‰©'] ? 'chip-active' : '' }}" data-name="è´­ç‰©" bindtap="toggleType">è´­ç‰©</view>
                <view class="chip {{ selectedMap['ä½“è‚²ä¼‘é—²'] ? 'chip-active' : '' }}" data-name="ä½“è‚²ä¼‘é—²" bindtap="toggleType">ä½“è‚²ä¼‘é—²</view>
              </view>
              <view class="chip-row">
                <view class="chip {{ selectedMap['é£æ™¯åèƒœ'] ? 'chip-active' : '' }}" data-name="é£æ™¯åèƒœ" bindtap="toggleType">é£æ™¯åèƒœ</view>
                <view class="chip {{ selectedMap['ç§‘æ•™æ–‡åŒ–'] ? 'chip-active' : '' }}" data-name="ç§‘æ•™æ–‡åŒ–" bindtap="toggleType">ç§‘æ•™æ–‡åŒ–</view>
              </view>
            </view>
            <view class="type-hint">
              <text class="hint-text">ğŸ’¡ é€‰æ‹©æ‚¨æ„Ÿå…´è¶£çš„ç›®çš„åœ°ç±»å‹</text>
            </view>
   

          <!-- åˆ†å‰²çº¿ -->
          <view class="divider"></view>

          <!-- æ¨¡å—2: ä¸ªäººåå¥½ -->
        
            <view class='type-section'>
            <view class="prefs-instructions">
              <view class="instr-title">è¯·ç”¨ä¸€ä¸¤å¥è¯æè¿°ä½ çš„åå¥½</view>
            </view>
            <textarea 
              class="prefs-textarea"
              value="{{form.prefs}}"
              placeholder="ä¾‹å¦‚ï¼šæƒ³æ‰¾ä¸ªå®‰é™ã€é€‚åˆæ‹ç…§ã€æœ‰ç‚¹å°èµ„æƒ…è°ƒçš„å’–å•¡é¦†"
              maxlength="200"
              auto-height
              bindinput="onPrefsInput"
            ></textarea>
          </view>
        </scroll-view>
      </swiper-item>

    </swiper>
  </view>

  <!-- å¯¼èˆªæŒ‰é’® -->
  <view class="navigation">
    <view class="nav-btn {{currentStep === 0 ? 'disabled' : ''}}" 
          bindtap="prevStep">
      <text class="nav-arrow">â€¹</text>
    </view>
    <view class="nav-btn {{currentStep === stepTitles.length - 1 ? 'disabled' : ''}}" 
          bindtap="nextStep">
      <text class="nav-arrow">â€º</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <view class="bottom-actions">
    <view class="btn-generate {{isGenerating ? 'generating' : ''}}" bindtap="handleBottomBtnTap" disabled="{{ isGenerating }}">
      <text class="btn-text">{{ generateBtnText }}</text>
    </view>
    <view class="star-burst-container" tt:if="{{isGenerating}}">
      <view class="star {{star.animation}}" 
            tt:for="{{burstStars}}" 
            tt:key="index" 
            tt:for-item="star" 
            tt:for-index="index"
            style="animation-delay: {{star.delay}}s;">
        â­
      </view>
    </view>
  </view>
  
  <movable-area class="movable-area-fullscreen">
  
    <!-- å¯æ‹–åŠ¨çš„è§†å›¾ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„å°äººå®¹å™¨ -->
    <movable-view 
      class="movable-gif-view" 
      direction="all" 
      x="{{gifX}}" 
      y="{{gifY}}"
    >
      <!-- ä½ çš„å›¾ç‰‡ç°åœ¨æ”¾åœ¨å¯æ‹–åŠ¨è§†å›¾çš„å†…éƒ¨ -->
      <image class="floating-gif-inner" src="/assets/tab/GIF-unscreen.gif" mode="widthFix"></image>
    </movable-view>
    
  </movable-area>
</view>